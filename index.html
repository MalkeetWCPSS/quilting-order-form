<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Long Arm Quilting Order Form</title>
  <style>
    @media print {
      body {
        background: #ffffff;
      }

      .hero {
        background: #ffffff !important;
        color: #111827 !important;
        box-shadow: none;
        border-radius: 0;
        border-bottom: 1px solid #d1d5db;
        padding: 18px 0 16px;
      }

      .hero p {
        color: #374151 !important;
      }

      .container {
        max-width: 100%;
        padding: 0;
      }

      .section {
        box-shadow: none;
        border: 1px solid #d1d5db;
        border-radius: 0;
        margin-bottom: 14px;
        page-break-inside: avoid;
      }

      .btn-row,
      .status-box,
      .remove-quilt-btn,
      #addQuiltBtn {
        display: none !important;
      }

      input,
      select,
      textarea {
        border: 0;
        padding: 0;
        background: transparent;
        box-shadow: none;
        appearance: none;
        -webkit-appearance: none;
        color: #111827;
      }

      .hint {
        display: none;
      }

      .quilt-card,
      .total-list,
      .mini-stat,
      .disclaimer-box {
        border-radius: 0;
        box-shadow: none;
        background: #ffffff;
      }

      .quilt-summary {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    :root {
      --panel: #ffffff;
      --text: #14161a;
      --muted: #5e6470;
      --line: #e5e7eb;
      --success: #ecfdf3;
      --success-border: #bbf7d0;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.06);
      --radius: 18px;
      --radius-sm: 12px;
      --max: 1180px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #f3f4f6 100%);
      color: var(--text);
    }

    .hero {
      background: linear-gradient(135deg, #0f172a 0%, #111827 55%, #1f2937 100%);
      color: white;
      padding: 36px 20px 30px;
      border-bottom-left-radius: 28px;
      border-bottom-right-radius: 28px;
      box-shadow: var(--shadow);
    }

    .hero-inner,
    .container {
      max-width: var(--max);
      margin: 0 auto;
    }

    .hero h1 {
      margin: 0 0 8px;
      font-size: clamp(1.8rem, 2.7vw, 2.8rem);
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0;
      color: rgba(255,255,255,.82);
      max-width: 760px;
      line-height: 1.55;
    }

    .container {
      padding: 24px 20px 40px;
    }

    .section {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
      margin-bottom: 18px;
    }

    .section h2 {
      margin: 0 0 6px;
      font-size: 1.15rem;
    }

    .section p.section-note {
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 0.94rem;
    }

    .grid-2,
    .grid-4 {
      display: grid;
      gap: 14px;
    }

    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

    @media (max-width: 940px) {
      .grid-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 720px) {
      .grid-2,
      .grid-4 { grid-template-columns: 1fr; }
      .hero { border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; }
      .section { padding: 18px; }
    }

    .field label {
      display: block;
      font-size: 0.88rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .required::after {
      content: " *";
      color: #b91c1c;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid #d7dbe2;
      background: #fff;
      border-radius: var(--radius-sm);
      padding: 12px 13px;
      font-size: 0.96rem;
      color: var(--text);
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.12);
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.45;
    }

    .quilt-card {
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 18px;
      background: linear-gradient(180deg, #fff 0%, #fcfcff 100%);
      margin-bottom: 16px;
    }

    .quilt-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .quilt-title {
      font-size: 1rem;
      font-weight: 800;
      margin: 0;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.82rem;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
      font-weight: 700;
    }

    .quilt-summary {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .quilt-summary { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 560px) {
      .quilt-summary { grid-template-columns: 1fr; }
    }

    .mini-stat {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: #fafafa;
    }

    .mini-stat .label {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .02em;
    }

    .mini-stat .value {
      font-size: 1rem;
      font-weight: 800;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 14px;
    }

    button {
      border: 0;
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-weight: 800;
      cursor: pointer;
      transition: transform .08s ease, opacity .2s ease;
    }

    button:hover { opacity: .96; }
    button:active { transform: translateY(1px); }

    .primary {
      background: linear-gradient(135deg, #111827, #312e81);
      color: white;
    }

    .secondary {
      background: #eef2ff;
      color: #312e81;
      border: 1px solid #c7d2fe;
    }

    .ghost {
      background: #f9fafb;
      color: #111827;
      border: 1px solid #d1d5db;
    }

    .danger {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3;
    }

    .totals-layout {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
    }

    @media (max-width: 900px) {
      .totals-layout { grid-template-columns: 1fr; }
    }

    .status-box,
    .disclaimer-box {
      border-radius: 16px;
      padding: 14px 16px;
      line-height: 1.55;
      font-size: 0.93rem;
    }

    .status-box {
      background: var(--success);
      border: 1px solid var(--success-border);
      color: #166534;
      display: none;
      margin-bottom: 14px;
    }

    .disclaimer-box {
      background: #f8fafc;
      border: 1px solid #dbe4f0;
      color: #334155;
    }

    .total-list {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: #fcfcfd;
      overflow: hidden;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      gap: 14px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      font-size: 0.95rem;
    }

    .total-row:last-child { border-bottom: 0; }
    .total-row strong { font-size: 1.02rem; }
    .grand { background: #f3f0ff; }

    .inline-money {
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <h1>Long Arm Quilting Order Form</h1>
      <p>
        Add one or more quilts to the same order, review a combined total, and download a printable customer invoice.
      </p>
    </div>
  </header>

  <main class="container">
    <form id="invoiceForm">
      <section class="section">
        <h2>Customer Information</h2>
        <p class="section-note">This information appears once, even if the order includes multiple quilts.</p>
        <div class="grid-4">
          <div class="field">
            <label class="required" for="dateOrdered">Date Ordered</label>
            <input id="dateOrdered" name="dateOrdered" type="date" required />
          </div>
          <div class="field">
            <label class="required" for="requestedDate">Requested Completion Date</label>
            <input id="requestedDate" name="requestedDate" type="date" required />
          </div>
          <div class="field">
            <label class="required" for="customerName">Customer Name</label>
            <input id="customerName" name="customerName" type="text" required />
          </div>
          <div class="field">
            <label class="required" for="phone">Phone Number</label>
            <input id="phone" name="phone" type="tel" required />
          </div>
        </div>
        <div class="grid-2" style="margin-top:14px;">
          <div class="field">
            <label class="required" for="email">Email</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="field">
            <label for="customerNotes">Customer Notes</label>
            <input id="customerNotes" name="customerNotes" type="text" placeholder="Optional notes about drop-off, timing, or special instructions" />
          </div>
        </div>
      </section>

      <section class="section">
        <h2>Quilt Items</h2>
        <p class="section-note">Each quilt has its own measurements, pricing, and subtotal. Add as many quilts as needed to one order.</p>
        <div id="quiltContainer"></div>
        <div class="btn-row">
          <button type="button" class="secondary" id="addQuiltBtn">+ Add Another Quilt</button>
        </div>
      </section>

      <section class="section">
        <h2>Order Extras, Shipping, and Disclaimer</h2>
        <p class="section-note">These items apply to the full order rather than to a single quilt line item.</p>
        <div class="grid-4">
          <div class="field">
            <label for="repairFee">Repairs</label>
            <input id="repairFee" type="number" step="0.01" min="0" value="0" />
            <div class="hint">Enter total repair charges for the full order.</div>
          </div>
          <div class="field">
            <label for="ironingFee">Ironing</label>
            <input id="ironingFee" type="number" step="0.01" min="0" value="0" />
          </div>
          <div class="field">
            <label for="trimmingFee">Trimming Quilt</label>
            <input id="trimmingFee" type="number" step="0.01" min="0" value="0" />
          </div>
          <div class="field">
            <label for="shippingFee">Shipping</label>
            <input id="shippingFee" type="number" step="0.01" min="0" value="0" />
          </div>
        </div>
        <div class="grid-2" style="margin-top:14px;">
          <div class="field">
            <label for="otherFee">Other Charges</label>
            <input id="otherFee" type="number" step="0.01" min="0" value="0" />
          </div>
          <div class="field">
            <label for="otherFeeLabel">Other Charge Description</label>
            <input id="otherFeeLabel" type="text" placeholder="Optional description for other charges" />
          </div>
        </div>
        <div class="grid-2" style="margin-top:14px;">
          <div class="field">
            <label for="signatureName">Customer Signature Name</label>
            <input id="signatureName" type="text" placeholder="Type full name to acknowledge terms" />
          </div>
          <div class="field">
            <label for="signatureDate">Signature Date</label>
            <input id="signatureDate" type="date" />
          </div>
        </div>
        <div class="field" style="margin-top:14px;">
          <label for="disclaimerText">Disclaimer / Terms</label>
          <textarea id="disclaimerText">Prices shown are estimates and may be adjusted after review of the quilt top, materials, requested quilting density, or additional work required.
By submitting this order, the customer acknowledges that final pricing and completion timing will be confirmed after review.
Please offer feedback on the completed work so I can continue improving my craft.</textarea>
        </div>
      </section>

      <section class="section">
        <h2>Order Summary</h2>
        <div class="totals-layout">
          <div>
            <div class="status-box" id="statusBox"></div>
            <div class="disclaimer-box" style="margin-top:14px;">
              Final pricing may be confirmed after review of the quilt top, materials, and requested quilting details.
            </div>
            <div class="btn-row" style="margin-top:16px;">
              <button type="button" class="primary" id="downloadBtn">Download Printable Invoice (HTML)</button>
              <button type="button" class="ghost" id="printBtn">Print / Save as PDF</button>
              <button type="reset" class="danger">Reset Form</button>
            </div>
          </div>
          <div>
            <div class="total-list">
              <div class="total-row"><span>Quilt Subtotal</span><strong class="inline-money" id="combinedQuiltSubtotal">$0.00</strong></div>
              <div class="total-row"><span>Order Extras</span><span class="inline-money" id="orderExtrasTotal">$0.00</span></div>
              <div class="total-row grand"><span><strong>Total Due</strong></span><strong class="inline-money" id="grandTotal">$0.00</strong></div>
            </div>
          </div>
        </div>
      </section>
    </form>
  </main>

  <template id="quiltTemplate">
    <article class="quilt-card">
      <div class="quilt-head">
        <div>
          <p class="quilt-title">Quilt <span class="quilt-number"></span></p>
          <div class="badge">Line item subtotal: <span class="inline-money quilt-line-subtotal">$0.00</span></div>
        </div>
        <button type="button" class="ghost remove-quilt-btn">Remove Quilt</button>
      </div>

      <div class="grid-4">
        <div class="field">
          <label class="required">Quilt Name / Description</label>
          <input type="text" class="quilt-name" placeholder="e.g., Kathy's Star Quilt" required />
        </div>
        <div class="field">
          <label>Thread Color</label>
          <input type="text" class="thread-color" placeholder="e.g., Cream" />
        </div>
        <div class="field">
          <label>Pattern / Design Notes</label>
          <input type="text" class="pattern-notes" placeholder="e.g., Feather swirl" />
        </div>
        <div class="field">
          <label>Quilting Style</label>
          <select class="quilting-style">
            <option value="Edge to Edge">Edge to Edge</option>
            <option value="Custom">Custom</option>
            <option value="Custom / Moderate">Custom / Moderate</option>
            <option value="Custom / Heavy">Custom / Heavy</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <div class="grid-4" style="margin-top:14px;">
        <div class="field">
          <label class="required">Width (inches)</label>
          <input type="number" step="0.01" min="0" class="width" required />
        </div>
        <div class="field">
          <label class="required">Length (inches)</label>
          <input type="number" step="0.01" min="0" class="length" required />
        </div>
        <div class="field">
          <label>Square Inches</label>
          <input type="text" class="square-inches" readonly />
          <div class="hint">Calculated automatically from width × length.</div>
        </div>
        <div class="field">
          <label>Quilting Rate (per sq in)</label>
          <input type="number" step="0.0001" min="0" class="quilting-rate" value="0.0200" />
          <div class="hint">Enter your actual rate for this quilt.</div>
        </div>
      </div>

      <div class="grid-4" style="margin-top:14px;">
        <div class="field">
          <label>Batting Type</label>
          <select class="batting-type">
            <option value="Customer Supplied">Customer Supplied</option>
            <option value="Poly">Poly</option>
            <option value="80/20">80/20</option>
            <option value="Wool">Wool</option>
            <option value="Bamboo">Bamboo</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="field">
          <label>Batting Rate (per sq in)</label>
          <input type="number" step="0.0001" min="0" class="batting-rate" value="0.0000" />
          <div class="hint">Examples: Poly 0.003, 80/20 0.005, Wool 0.0065.</div>
        </div>
        <div class="field">
          <label>Backing Price per Yard</label>
          <input type="number" step="0.01" min="0" class="backing-rate" value="0.00" />
        </div>
        <div class="field">
          <label>Backing Yards</label>
          <input type="number" step="0.1" min="0" class="backing-yards" value="0" />
        </div>
      </div>

      <div class="grid-4" style="margin-top:14px;">
        <div class="field">
          <label>Thread Type</label>
          <select class="thread-type">
            <option value="Regular">Regular</option>
            <option value="Specialty">Specialty</option>
          </select>
        </div>
        <div class="field">
          <label>Thread Upcharge</label>
          <input type="number" step="0.01" min="0" class="thread-upcharge" value="0.00" />
          <div class="hint">Set this to $10.00 or any other amount when specialty thread is used.</div>
        </div>
        <div class="field">
          <label>Label Fee</label>
          <input type="number" step="0.01" min="0" class="label-fee" value="0.00" />
        </div>
        <div class="field">
          <label>Other Quilt-Specific Fee</label>
          <input type="number" step="0.01" min="0" class="other-quilt-fee" value="0.00" />
        </div>
      </div>

      <div class="grid-2" style="margin-top:14px;">
        <div class="field">
          <label>Backing Pattern / Fabric Notes</label>
          <input type="text" class="backing-pattern" placeholder="Optional backing notes" />
        </div>
        <div class="field">
          <label>Quilt Notes</label>
          <input type="text" class="quilt-notes" placeholder="Optional line-item notes" />
        </div>
      </div>

      <div class="quilt-summary">
        <div class="mini-stat">
          <div class="label">Quilting Total</div>
          <div class="value inline-money quilting-total">$0.00</div>
        </div>
        <div class="mini-stat">
          <div class="label">Batting Total</div>
          <div class="value inline-money batting-total">$0.00</div>
        </div>
        <div class="mini-stat">
          <div class="label">Backing Total</div>
          <div class="value inline-money backing-total">$0.00</div>
        </div>
        <div class="mini-stat">
          <div class="label">Extras Total</div>
          <div class="value inline-money quilt-extras-total">$0.00</div>
        </div>
      </div>
    </article>
  </template>

  <script>
    const quiltContainer = document.getElementById('quiltContainer');
    const quiltTemplate = document.getElementById('quiltTemplate');
    const addQuiltBtn = document.getElementById('addQuiltBtn');
    const form = document.getElementById('invoiceForm');
    const statusBox = document.getElementById('statusBox');

    function money(value) {
      const numericValue = Number(value) || 0;
      return numericValue.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    }

    function num(value) {
      const parsed = parseFloat(value);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function setTodayDefaults() {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('dateOrdered').value = today;
      if (!document.getElementById('signatureDate').value) {
        document.getElementById('signatureDate').value = today;
      }
    }

    function addQuilt(defaults = {}) {
      const fragment = quiltTemplate.content.cloneNode(true);
      const card = fragment.querySelector('.quilt-card');

      const fields = {
        quiltName: card.querySelector('.quilt-name'),
        threadColor: card.querySelector('.thread-color'),
        patternNotes: card.querySelector('.pattern-notes'),
        quiltingStyle: card.querySelector('.quilting-style'),
        width: card.querySelector('.width'),
        length: card.querySelector('.length'),
        squareInches: card.querySelector('.square-inches'),
        quiltingRate: card.querySelector('.quilting-rate'),
        battingType: card.querySelector('.batting-type'),
        battingRate: card.querySelector('.batting-rate'),
        backingRate: card.querySelector('.backing-rate'),
        backingYards: card.querySelector('.backing-yards'),
        threadType: card.querySelector('.thread-type'),
        threadUpcharge: card.querySelector('.thread-upcharge'),
        labelFee: card.querySelector('.label-fee'),
        otherQuiltFee: card.querySelector('.other-quilt-fee'),
        backingPattern: card.querySelector('.backing-pattern'),
        quiltNotes: card.querySelector('.quilt-notes')
      };

      Object.entries(defaults).forEach(([key, value]) => {
        if (fields[key]) fields[key].value = value;
      });

      fields.threadType.addEventListener('change', () => {
        if (fields.threadType.value === 'Specialty' && num(fields.threadUpcharge.value) === 0) {
          fields.threadUpcharge.value = '10.00';
        }
        if (fields.threadType.value === 'Regular' && num(fields.threadUpcharge.value) === 10) {
          fields.threadUpcharge.value = '0.00';
        }
        recalcAll();
      });

      fields.battingType.addEventListener('change', () => {
        const type = fields.battingType.value;
        const presets = {
          'Customer Supplied': '0.0000',
          'Poly': '0.0030',
          '80/20': '0.0050',
          'Wool': '0.0065',
          'Bamboo': '0.0065'
        };
        if (presets[type] !== undefined) {
          fields.battingRate.value = presets[type];
        }
        recalcAll();
      });

      card.querySelectorAll('input, select').forEach((el) => {
        el.addEventListener('input', recalcAll);
        el.addEventListener('change', recalcAll);
      });

      card.querySelector('.remove-quilt-btn').addEventListener('click', () => {
        card.remove();
        renumberQuilts();
        recalcAll();
      });

      quiltContainer.appendChild(fragment);
      renumberQuilts();
      recalcAll();
    }

    function renumberQuilts() {
      const cards = quiltContainer.querySelectorAll('.quilt-card');
      cards.forEach((card, index) => {
        card.querySelector('.quilt-number').textContent = index + 1;
        const removeBtn = card.querySelector('.remove-quilt-btn');
        removeBtn.style.display = cards.length === 1 ? 'none' : 'inline-flex';
      });
    }

    function calculateCard(card) {
      const width = num(card.querySelector('.width').value);
      const length = num(card.querySelector('.length').value);
      const squareInches = width * length;
      const quiltingRate = num(card.querySelector('.quilting-rate').value);
      const battingRate = num(card.querySelector('.batting-rate').value);
      const backingRate = num(card.querySelector('.backing-rate').value);
      const backingYards = num(card.querySelector('.backing-yards').value);
      const threadUpcharge = num(card.querySelector('.thread-upcharge').value);
      const labelFee = num(card.querySelector('.label-fee').value);
      const otherQuiltFee = num(card.querySelector('.other-quilt-fee').value);

      const quiltingTotal = squareInches * quiltingRate;
      const battingTotal = squareInches * battingRate;
      const backingTotal = backingRate * backingYards;
      const quiltExtrasTotal = threadUpcharge + labelFee + otherQuiltFee;
      const subtotal = quiltingTotal + battingTotal + backingTotal + quiltExtrasTotal;

      card.querySelector('.square-inches').value = squareInches ? squareInches.toFixed(2) : '';
      card.querySelector('.quilting-total').textContent = money(quiltingTotal);
      card.querySelector('.batting-total').textContent = money(battingTotal);
      card.querySelector('.backing-total').textContent = money(backingTotal);
      card.querySelector('.quilt-extras-total').textContent = money(quiltExtrasTotal);
      card.querySelector('.quilt-line-subtotal').textContent = money(subtotal);

      return {
        squareInches,
        quiltingTotal,
        battingTotal,
        backingTotal,
        quiltExtrasTotal,
        subtotal
      };
    }

    function recalcAll() {
      let combinedQuiltSubtotal = 0;
      quiltContainer.querySelectorAll('.quilt-card').forEach((card) => {
        const calc = calculateCard(card);
        combinedQuiltSubtotal += calc.subtotal;
      });

      const repairs = num(document.getElementById('repairFee').value);
      const ironing = num(document.getElementById('ironingFee').value);
      const trimming = num(document.getElementById('trimmingFee').value);
      const shipping = num(document.getElementById('shippingFee').value);
      const other = num(document.getElementById('otherFee').value);
      const orderExtrasTotal = repairs + ironing + trimming + shipping + other;
      const grandTotal = combinedQuiltSubtotal + orderExtrasTotal;

      document.getElementById('combinedQuiltSubtotal').textContent = money(combinedQuiltSubtotal);
      document.getElementById('orderExtrasTotal').textContent = money(orderExtrasTotal);
      document.getElementById('grandTotal').textContent = money(grandTotal);
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatMultilineText(text) {
      return escapeHtml(text).replace(/\r\n|\r|\n/g, '<br>');
    }

    function currentDateLabel() {
      return new Date().toLocaleDateString(undefined, {
        year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    function buildPrintableInvoiceHtml() {
      const customer = {
        dateOrdered: document.getElementById('dateOrdered').value,
        requestedDate: document.getElementById('requestedDate').value,
        customerName: document.getElementById('customerName').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        customerNotes: document.getElementById('customerNotes').value
      };

      const repairs = num(document.getElementById('repairFee').value);
      const ironing = num(document.getElementById('ironingFee').value);
      const trimming = num(document.getElementById('trimmingFee').value);
      const shipping = num(document.getElementById('shippingFee').value);
      const otherFee = num(document.getElementById('otherFee').value);
      const otherFeeLabel = document.getElementById('otherFeeLabel').value.trim() || 'Other charges';
      const signatureName = document.getElementById('signatureName').value;
      const signatureDate = document.getElementById('signatureDate').value;
      const disclaimerText = document.getElementById('disclaimerText').value;

      let combinedQuiltSubtotal = 0;
      let quiltRows = '';
      let quiltDetails = '';

      quiltContainer.querySelectorAll('.quilt-card').forEach((card, index) => {
        const width = num(card.querySelector('.width').value);
        const length = num(card.querySelector('.length').value);
        const squareInches = width * length;
        const quiltingRate = num(card.querySelector('.quilting-rate').value);
        const battingRate = num(card.querySelector('.batting-rate').value);
        const backingRate = num(card.querySelector('.backing-rate').value);
        const backingYards = num(card.querySelector('.backing-yards').value);
        const threadUpcharge = num(card.querySelector('.thread-upcharge').value);
        const labelFee = num(card.querySelector('.label-fee').value);
        const otherQuiltFee = num(card.querySelector('.other-quilt-fee').value);

        const quiltingTotal = squareInches * quiltingRate;
        const battingTotal = squareInches * battingRate;
        const backingTotal = backingRate * backingYards;
        const quiltExtrasTotal = threadUpcharge + labelFee + otherQuiltFee;
        const subtotal = quiltingTotal + battingTotal + backingTotal + quiltExtrasTotal;
        combinedQuiltSubtotal += subtotal;

        const quiltName = card.querySelector('.quilt-name').value || `Quilt ${index + 1}`;
        const threadColor = card.querySelector('.thread-color').value;
        const patternNotes = card.querySelector('.pattern-notes').value;
        const quiltingStyle = card.querySelector('.quilting-style').value;
        const battingType = card.querySelector('.batting-type').value;
        const threadType = card.querySelector('.thread-type').value;
        const backingPattern = card.querySelector('.backing-pattern').value;
        const quiltNotes = card.querySelector('.quilt-notes').value;

        quiltRows += `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(quiltName)}</td>
            <td>${escapeHtml(quiltingStyle)}</td>
            <td>${squareInches.toFixed(2)}</td>
            <td>$${quiltingRate.toFixed(4)}</td>
            <td>${money(subtotal)}</td>
          </tr>`;

        quiltDetails += `
          <section class="quilt-detail">
            <h3>Quilt ${index + 1}: ${escapeHtml(quiltName)}</h3>
            <table>
              <tr><th>Thread Color</th><td>${escapeHtml(threadColor || '-')}</td><th>Pattern / Design</th><td>${escapeHtml(patternNotes || '-')}</td></tr>
              <tr><th>Quilting Style</th><td>${escapeHtml(quiltingStyle)}</td><th>Dimensions</th><td>${width} × ${length} in</td></tr>
              <tr><th>Square Inches</th><td>${squareInches.toFixed(2)}</td><th>Quilting Rate</th><td>$${quiltingRate.toFixed(4)} per sq in</td></tr>
              <tr><th>Quilting Total</th><td>${money(quiltingTotal)}</td><th>Batting Type</th><td>${escapeHtml(battingType)}</td></tr>
              <tr><th>Batting Rate</th><td>$${battingRate.toFixed(4)} per sq in</td><th>Batting Total</th><td>${money(battingTotal)}</td></tr>
              <tr><th>Backing Rate</th><td>${money(backingRate)} per yard</td><th>Backing Yards</th><td>${backingYards.toFixed(1)}</td></tr>
              <tr><th>Backing Total</th><td>${money(backingTotal)}</td><th>Thread Type</th><td>${escapeHtml(threadType)}</td></tr>
              <tr><th>Thread Upcharge</th><td>${money(threadUpcharge)}</td><th>Label Fee</th><td>${money(labelFee)}</td></tr>
              <tr><th>Other Quilt Fee</th><td>${money(otherQuiltFee)}</td><th>Line Item Subtotal</th><td><strong>${money(subtotal)}</strong></td></tr>
              <tr><th>Backing Notes</th><td>${escapeHtml(backingPattern || '-')}</td><th>Quilt Notes</th><td>${escapeHtml(quiltNotes || '-')}</td></tr>
            </table>
          </section>`;
      });

      const orderExtrasTotal = repairs + ironing + trimming + shipping + otherFee;
      const grandTotal = combinedQuiltSubtotal + orderExtrasTotal;

      return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Printable Quilting Invoice</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; color: #111827; margin: 28px; }
    .header { display: flex; justify-content: space-between; gap: 24px; border-bottom: 2px solid #111827; padding-bottom: 14px; margin-bottom: 20px; }
    h1 { margin: 0 0 6px; font-size: 28px; }
    h2 { margin: 22px 0 10px; font-size: 18px; }
    h3 { margin: 18px 0 10px; font-size: 15px; }
    p { margin: 4px 0; line-height: 1.5; }
    .meta, .customer { width: 100%; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 18px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #d1d5db; padding: 8px 10px; text-align: left; vertical-align: top; }
    th { background: #f3f4f6; width: 22%; }
    .summary-table th, .summary-table td { text-align: left; }
    .summary-table td.amount { text-align: right; white-space: nowrap; }
    .invoice-table td, .invoice-table th { font-size: 14px; }
    .total-row td { font-weight: 700; font-size: 16px; background: #eef2ff; }
    .quilt-detail { page-break-inside: avoid; margin-top: 14px; }
    .disclaimer { border: 1px solid #d1d5db; background: #fafafa; padding: 12px; margin-top: 18px; }
    .signature { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .line { border-bottom: 1px solid #111827; min-height: 24px; padding-top: 4px; }
    @media print { body { margin: 16px; } }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>Long Arm Quilting Invoice</h1>
      <p>Prepared on ${escapeHtml(currentDateLabel())}</p>
    </div>
    <div class="meta">
      <p><strong>Date Ordered:</strong> ${escapeHtml(customer.dateOrdered)}</p>
      <p><strong>Requested Completion Date:</strong> ${escapeHtml(customer.requestedDate)}</p>
    </div>
  </div>

  <div class="two-col">
    <div class="customer">
      <h2>Customer Information</h2>
      <p><strong>Name:</strong> ${escapeHtml(customer.customerName)}</p>
      <p><strong>Phone:</strong> ${escapeHtml(customer.phone)}</p>
      <p><strong>Email:</strong> ${escapeHtml(customer.email)}</p>
      <p><strong>Notes:</strong> ${escapeHtml(customer.customerNotes || '-')}</p>
    </div>
    <div>
      <h2>Invoice Overview</h2>
      <table class="invoice-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Quilt</th>
            <th>Style</th>
            <th>Sq In</th>
            <th>Rate</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          ${quiltRows}
        </tbody>
      </table>
    </div>
  </div>

  <h2>Detailed Quilt Line Items</h2>
  ${quiltDetails}

  <h2>Invoice Totals</h2>
  <table class="summary-table">
    <tr><th>Combined Quilt Subtotal</th><td class="amount">${money(combinedQuiltSubtotal)}</td></tr>
    <tr><th>Repairs</th><td class="amount">${money(repairs)}</td></tr>
    <tr><th>Ironing</th><td class="amount">${money(ironing)}</td></tr>
    <tr><th>Trimming Quilt</th><td class="amount">${money(trimming)}</td></tr>
    <tr><th>Shipping</th><td class="amount">${money(shipping)}</td></tr>
    <tr><th>${escapeHtml(otherFeeLabel)}</th><td class="amount">${money(otherFee)}</td></tr>
    <tr class="total-row"><td>Total Due</td><td class="amount">${money(grandTotal)}</td></tr>
  </table>

  <div class="disclaimer">
    <strong>Disclaimer / Terms</strong>
    <p>${formatMultilineText(disclaimerText)}</p>
  </div>

  <div class="signature">
    <div>
      <strong>Customer Signature Name</strong>
      <div class="line">${escapeHtml(signatureName || '')}</div>
    </div>
    <div>
      <strong>Signature Date</strong>
      <div class="line">${escapeHtml(signatureDate || '')}</div>
    </div>
  </div>
</body>
</html>`;
    }

    function downloadFile(filename, content, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function attachGlobalRecalc() {
      ['repairFee', 'ironingFee', 'trimmingFee', 'shippingFee', 'otherFee', 'otherFeeLabel'].forEach((id) => {
        document.getElementById(id).addEventListener('input', recalcAll);
      });
    }

    function runSelfTests() {
      const tests = [];

      tests.push({
        name: 'escapeHtml escapes angle brackets',
        pass: escapeHtml('<b>Test</b>') === '&lt;b&gt;Test&lt;/b&gt;'
      });

      tests.push({
        name: 'formatMultilineText converts newlines to br',
        pass: formatMultilineText('Line 1\nLine 2') === 'Line 1<br>Line 2'
      });

      tests.push({
        name: 'formatMultilineText handles CRLF newlines',
        pass: formatMultilineText('Line 1\r\nLine 2') === 'Line 1<br>Line 2'
      });

      tests.push({
        name: 'money formats zero as USD',
        pass: typeof money(0) === 'string' && money(0).includes('0')
      });

      tests.push({
        name: 'order summary total element exists',
        pass: !!document.getElementById('orderExtrasTotal')
      });

      const failed = tests.filter((test) => !test.pass);
      if (failed.length) {
        console.error('Self-tests failed:', failed);
      } else {
        console.info('All self-tests passed.');
      }
    }

    addQuiltBtn.addEventListener('click', () => addQuilt());

    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (!form.reportValidity()) return;
      recalcAll();
      const html = buildPrintableInvoiceHtml();
      const safeName = (document.getElementById('customerName').value || 'invoice').trim().replace(/[^a-z0-9]+/gi, '_');
      const filename = `quilting_invoice_${safeName}.html`;
      downloadFile(filename, html, 'text/html;charset=utf-8');
      statusBox.style.display = 'block';
      statusBox.textContent = 'Printable invoice downloaded. Open the file in your browser and use Print or Save as PDF for a polished customer copy.';
    });

    document.getElementById('printBtn').addEventListener('click', () => {
      window.print();
    });

    form.addEventListener('reset', () => {
      setTimeout(() => {
        quiltContainer.innerHTML = '';
        addQuilt();
        setTodayDefaults();
        document.getElementById('disclaimerText').value = `Prices shown are estimates and may be adjusted after review of the quilt top, materials, requested quilting density, or additional work required.
By submitting this order, the customer acknowledges that final pricing and completion timing will be confirmed after review.
Please offer feedback on the completed work so I can continue improving my craft.`;
        statusBox.style.display = 'none';
        recalcAll();
      }, 0);
    });

    setTodayDefaults();
    attachGlobalRecalc();
    addQuilt();
    runSelfTests();
  </script>
</body>
</html>
