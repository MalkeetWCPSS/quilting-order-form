<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Long Arm Quilting Order Form</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --text: #14161a;
      --muted: #5e6470;
      --line: #e5e7eb;
      --accent: #1f2937;
      --accent-soft: #eef2ff;
      --success: #ecfdf3;
      --success-border: #bbf7d0;
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.06);
      --radius: 18px;
      --radius-sm: 12px;
      --max: 1180px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #f3f4f6 100%);
      color: var(--text);
    }

    .hero {
      background: linear-gradient(135deg, #0f172a 0%, #111827 55%, #1f2937 100%);
      color: white;
      padding: 36px 20px 30px;
      border-bottom-left-radius: 28px;
      border-bottom-right-radius: 28px;
      box-shadow: var(--shadow);
    }

    .hero-inner, .container {
      max-width: var(--max);
      margin: 0 auto;
    }

    .hero h1 {
      margin: 0 0 8px;
      font-size: clamp(1.8rem, 2.7vw, 2.8rem);
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0;
      color: rgba(255,255,255,.84);
      max-width: 820px;
      line-height: 1.55;
    }

    .container {
      padding: 24px 20px 40px;
    }

    .section {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
      margin-bottom: 18px;
    }

    .section h2 {
      margin: 0 0 6px;
      font-size: 1.15rem;
    }

    .section p.section-note {
      margin: 0 0 18px;
      color: var(--muted);
      font-size: 0.94rem;
    }

    .grid-2, .grid-3, .grid-4 {
      display: grid;
      gap: 14px;
    }

    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

    @media (max-width: 940px) {
      .grid-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .grid-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 720px) {
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .hero { border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; }
      .section { padding: 18px; }
    }

    .field label {
      display: block;
      font-size: 0.88rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .required::after {
      content: " *";
      color: #b91c1c;
    }

    input, select, textarea {
      width: 100%;
      border: 1px solid #d7dbe2;
      background: #fff;
      border-radius: var(--radius-sm);
      padding: 12px 13px;
      font-size: 0.96rem;
      color: var(--text);
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.12);
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .hint {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.45;
    }

    details.panel {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: #fcfcff;
      overflow: hidden;
      margin-bottom: 14px;
    }

    details.panel[open] {
      box-shadow: 0 8px 20px rgba(17, 24, 39, 0.05);
    }

    details.panel > summary {
      list-style: none;
      cursor: pointer;
      padding: 16px 18px;
      font-weight: 800;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    details.panel > summary::-webkit-details-marker { display: none; }

    .summary-right {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: #374151;
      font-weight: 700;
      font-size: 0.92rem;
    }

    .panel-body {
      padding: 18px;
    }

    .quilt-card {
      border: 1px solid var(--line);
      border-radius: 20px;
      background: linear-gradient(180deg, #fff 0%, #fcfcff 100%);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .quilt-top {
      padding: 16px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      background: #fafafa;
      border-bottom: 1px solid var(--line);
    }

    .quilt-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 0.82rem;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
      font-weight: 700;
    }

    .quilt-body {
      padding: 18px;
    }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    @media (max-width: 900px) {
      .mini-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 560px) {
      .mini-grid { grid-template-columns: 1fr; }
    }

    .mini-stat {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: #fafafa;
    }

    .mini-stat .label {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .02em;
    }

    .mini-stat .value {
      font-size: 1rem;
      font-weight: 800;
    }

    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    @media (max-width: 720px) {
      .checkbox-grid { grid-template-columns: 1fr; }
    }

    .check-card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .check-card input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 14px;
    }

    button {
      border: 0;
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-weight: 800;
      cursor: pointer;
      transition: transform .08s ease, opacity .2s ease;
    }

    button:hover { opacity: .96; }
    button:active { transform: translateY(1px); }

    .primary { background: linear-gradient(135deg, #111827, #312e81); color: white; }
    .secondary { background: #eef2ff; color: #312e81; border: 1px solid #c7d2fe; }
    .ghost { background: #f9fafb; color: #111827; border: 1px solid #d1d5db; }
    .danger { background: #fff1f2; color: #9f1239; border: 1px solid #fecdd3; }

    .totals-layout {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
    }

    @media (max-width: 900px) {
      .totals-layout { grid-template-columns: 1fr; }
    }

    .status-box, .disclaimer-box {
      border-radius: 16px;
      padding: 14px 16px;
      line-height: 1.55;
      font-size: 0.93rem;
    }

    .status-box {
      background: var(--success);
      border: 1px solid var(--success-border);
      color: #166534;
      display: none;
      margin-bottom: 14px;
    }

    .disclaimer-box {
      background: #f8fafc;
      border: 1px solid #dbe4f0;
      color: #334155;
    }

    .total-list {
      border: 1px solid var(--line);
      border-radius: 18px;
      background: #fcfcfd;
      overflow: hidden;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      gap: 14px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      font-size: 0.95rem;
    }

    .total-row:last-child { border-bottom: 0; }
    .grand { background: #f3f0ff; }
    .inline-money { font-variant-numeric: tabular-nums; white-space: nowrap; }

    @media print {
      body { background: #ffffff; }
      .hero {
        background: #ffffff !important;
        color: #111827 !important;
        box-shadow: none;
        border-radius: 0;
        border-bottom: 1px solid #d1d5db;
        padding: 18px 0 16px;
      }
      .hero p { color: #374151 !important; }
      .container { max-width: 100%; padding: 0; }
      .section {
        box-shadow: none;
        border: 1px solid #d1d5db;
        border-radius: 0;
        margin-bottom: 14px;
        page-break-inside: avoid;
      }
      .btn-row, .status-box, .remove-quilt-btn, #addQuiltBtn {
        display: none !important;
      }
      details.panel { border-radius: 0; box-shadow: none; }
      details.panel > summary { background: #ffffff; }
      input, select, textarea {
        border: 0;
        padding: 0;
        background: transparent;
        box-shadow: none;
        appearance: none;
        -webkit-appearance: none;
        color: #111827;
      }
      .hint { display: none; }
      .quilt-card, .total-list, .mini-stat, .disclaimer-box {
        border-radius: 0;
        box-shadow: none;
        background: #ffffff;
      }
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <h1>Long Arm Quilting Order Form</h1>
      
    </div>
  </header>

  <main class="container">
    <form id="invoiceForm">
      <section class="section">
        <h2>Customer Information</h2>
        
        <div class="grid-4">
          <div class="field">
            <label class="required" for="dateOrdered">Date Ordered</label>
            <input id="dateOrdered" name="dateOrdered" type="date" required />
          </div>
          <div class="field">
            <label class="required" for="requestedDate">Estimated Completion Date</label>
            <input id="requestedDate" name="requestedDate" type="date" required />
          </div>
          <div class="field">
            <label class="required" for="customerName">Customer Name</label>
            <input id="customerName" name="customerName" type="text" required />
          </div>
          <div class="field">
            <label class="required" for="phone">Phone Number</label>
            <input id="phone" name="phone" type="tel" required />
          </div>
        </div>
        <div class="grid-2" style="margin-top:14px;">
          <div class="field">
            <label class="required" for="email">Email</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="field">
            <label for="customerNotes">Customer Notes</label>
            <input id="customerNotes" name="customerNotes" type="text" placeholder="Optional notes about drop-off, pickup, or special instructions" />
          </div>
        </div>
      </section>

      <section class="section">
        <h2>Quilt Items</h2>
        
        <div id="quiltContainer"></div>
        <div class="btn-row">
          <button type="button" class="secondary" id="addQuiltBtn">+ Add Another Quilt</button>
        </div>
      </section>

      <section class="section">
        <h2>Terms and Signature</h2>
        <div class="grid-2" style="margin-top:14px;">
          <div class="field">
            <label for="minimumAgreed">Minimum Agreed</label>
            <input id="minimumAgreed" type="text" placeholder="Optional agreed minimum or note" />
          </div>
          <div class="field">
            <label for="signatureName">Customer Signature Name</label>
            <input id="signatureName" type="text" placeholder="Type full name to acknowledge terms" />
          </div>
        </div>
        <div class="grid-2" style="margin-top:14px;">
          <div class="field">
            <label for="signatureDate">Signature Date</label>
            <input id="signatureDate" type="date" />
          </div>
          <div class="field"></div>
        </div>
        <div class="field" style="margin-top:14px;">
          <label for="disclaimerText">Disclaimer / Terms</label>
          <div id="disclaimerText" class="disclaimer-fixed">By signing this form, you confirm that the invoice information is accurate and that you accept the services and charges associated with your quilt(s), including selected patterns, thread, and other products.<br><br>
Payment is due upon pickup and must be made within 14 days of project completion.<br><br>
Although Bobbin &amp; Needle strives for excellence in every quilt, minor variations in stitching may occur.<br><br>
In the unlikely event that your quilt is damaged while in our possession, any resolution will be limited, at our discretion, to the average replacement cost of the fabric used.<br><br>
Should any additional charges arise, we will notify you and obtain your approval before continuing work.</div>
        </div>
      </section>

      <section class="section">
        <h2>Order Summary</h2>
        <div class="totals-layout">
          <div>
            <div class="status-box" id="statusBox"></div>
            <div class="disclaimer-box" style="margin-top:14px;">
              Charges for repairs, ironing, trimming, and similar items are now included inside each quilt’s pricing rather than only at the order level.
            </div>
            <div class="btn-row" style="margin-top:16px;">
              <button type="button" class="primary" id="downloadBtn">Download Printable Invoice (HTML)</button>
              <button type="button" class="ghost" id="printBtn">Print / Save as PDF</button>
              <button type="reset" class="danger">Reset Form</button>
            </div>
          </div>
          <div>
            <div class="total-list">
              <div class="total-row"><span>Quilts in Order</span><strong id="quiltCount">1</strong></div>
              <div class="total-row"><span>Quilt Subtotal</span><strong class="inline-money" id="combinedQuiltSubtotal">$0.00</strong></div>
              <div class="total-row grand"><span><strong>Total Due</strong></span><strong class="inline-money" id="grandTotal">$0.00</strong></div>
            </div>
          </div>
        </div>
      </section>
    </form>
  </main>

  <template id="quiltTemplate">
    <details class="quilt-card" open>
      <summary class="quilt-top">
        <div>
          <p class="quilt-title">Quilt <span class="quilt-number"></span></p>
        </div>
        <div class="summary-right">
          <span class="badge">Subtotal: <span class="inline-money quilt-line-subtotal">$0.00</span></span>
          <button type="button" class="ghost remove-quilt-btn">Remove</button>
        </div>
      </summary>

      <div class="quilt-body">
        <details class="panel" open>
          <summary>
            <span>Quilt Top Details</span>
            <span class="summary-right"><span class="inline-money quilt-square-inches-badge">0.00 sq in</span></span>
          </summary>
          <div class="panel-body">
            <div class="grid-4">
              <div class="field">
                <label class="required">Width of Quilt Top (inches)</label>
                <input type="number" step="0.01" min="0" class="width" required />
              </div>
              <div class="field">
                <label class="required">Length of Quilt Top (inches)</label>
                <input type="number" step="0.01" min="0" class="length" required />
              </div>
              <div class="field">
                <label>Square Inches</label>
                <input type="text" class="square-inches" readonly />
                <div class="hint">Calculated automatically from width × length.</div>
              </div>
              <div class="field">
                <label class="required">Pattern</label>
                <input type="text" class="pattern" required />
              </div>
            </div>
          </div>
        </details>

        <details class="panel" open>
          <summary>
            <span>Labor</span>
            <span class="summary-right"><span class="inline-money quilting-total-badge">$0.00</span></span>
          </summary>
          <div class="panel-body">
            <div class="grid-3">
              <div class="field">
                <label class="required">Quilting Design--Edge to Edge</label>
                <select class="e2e-design">
                  <option value="None ($0)" data-rate="0">None ($0)</option>
                  <option value="Regular Stitch Density ($0.02/sq in)" data-rate="0.02" selected>Regular Stitch Density ($0.02/sq in)</option>
                  <option value="Complex Stitch Density ($0.03/sq in)" data-rate="0.03">Complex Stitch Density ($0.03/sq in)</option>
                </select>
              </div>
              <div class="field">
                <label class="required">Quilting Design--Custom</label>
                <select class="custom-design">
                  <option value="None">None</option>
                  <option value="Regular">Regular</option>
                  <option value="Moderate">Moderate</option>
                  <option value="Heavy">Heavy</option>
                </select>
                <div class="hint">This selection is recorded on the invoice. Automatic pricing is based on the edge-to-edge list above.</div>
              </div>
              <div class="field">
                <label>Time Required</label>
                <select class="minutes-stitching">
                  <option value="None">None</option>
                  <option value="Other">Other:</option>
                </select>
              </div>
            </div>
          </div>
        </details>

        <details class="panel" open>
          <summary>
            <span>Materials</span>
            <span class="summary-right"><span class="inline-money materials-total-badge">$0.00</span></span>
          </summary>
          <div class="panel-body">
            <div class="grid-4">
              <div class="field">
                <label class="required">Batting Type</label>
                <select class="batting-type">
                  <option value="Customer Supplied ($0)" data-rate="0">Customer Supplied ($0)</option>
                  <option value="Poly ($8/yard)" data-rate="8">Poly ($8/yard)</option>
                  <option value="80/20 ($9/yard)" data-rate="9">80/20 ($9/yard)</option>
                  <option value="Wool ($10/yard)" data-rate="10">Wool ($10/yard)</option>
                  <option value="Bamboo ($11/yard)" data-rate="11">Bamboo ($11/yard)</option>
                </select>
              </div>
              <div class="field">
                <label class="required">Thread</label>
                <select class="thread-type">
                  <option value="Regular">Regular</option>
                  <option value="Specialty">Specialty</option>
                </select>
              </div>
              <div class="field">
                <label>Thread upcharge ($)</label>
                <input type="number" step="0.01" min="0" class="thread-upcharge" value="0" />
              </div>
              <div class="field">
                <label class="required">B&N Supplied Backing Fabric</label>
                <select class="backing-supplied">
                  <option value="No ($0)" data-rate="0">No ($0)</option>
                  <option value="Regular Price ($10/yd)" data-rate="10">Regular Price ($10/yd)</option>
                  <option value="Friend's Discount ($7/yd)" data-rate="7">Friend's Discount ($7/yd)</option>
                </select>
              </div>
            </div>
            <div class="grid-4" style="margin-top:14px;">
              <div class="field">
                <label class="required">Yards of Backing</label>
                <input type="number" step="0.1" min="0" class="backing-yards" value="0" />
              </div>
              <div class="field"></div>
              <div class="field"></div>
              <div class="field"></div>
            </div>
          </div>
        </details>

        <details class="panel" open>
          <summary>
            <span>Extras and Notes</span>
            <span class="summary-right"><span class="inline-money extras-total-badge">$0.00</span></span>
          </summary>
          <div class="panel-body">
            <div class="grid-4">
              <div class="field">
                <label>Embroidered Quilt Label</label>
                <input type="text" class="label-notes" placeholder="Optional label details" />
              </div>
              <div class="field">
                <label>Minimum Outside Border After Trimming (inches)</label>
                <input type="number" step="0.25" min="0" class="minimum-border" value="0" />
              </div>
              <div class="field">
                <label>Minimum agreed</label>
                <input type="text" class="minimum-agreed-line" placeholder="Optional line-item note" />
              </div>
              <div class="field">
                <label>Other Charges</label>
                <div class="checkbox-grid">
                  <label class="check-card"><input type="checkbox" class="charge-repair" /> Repairs ($10)</label>
                  <label class="check-card"><input type="checkbox" class="charge-ironing" /> Ironing ($10)</label>
                  <label class="check-card"><input type="checkbox" class="charge-trimming" /> Trimming Quilt ($10)</label>
                </div>
              </div>
            </div>
          </div>
        </details>

        <div class="mini-grid">
          <div class="mini-stat">
            <div class="label">Labor</div>
            <div class="value inline-money quilting-total">$0.00</div>
          </div>
          <div class="mini-stat">
            <div class="label">Material</div>
            <div class="value inline-money material-total">$0.00</div>
          </div>
          <div class="mini-stat">
            <div class="label">Extras</div>
            <div class="value inline-money quilt-extras-total">$0.00</div>
          </div>
        </div>
      </div>
    </details>
  </template>

  <script>
    const quiltContainer = document.getElementById('quiltContainer');
    const quiltTemplate = document.getElementById('quiltTemplate');
    const addQuiltBtn = document.getElementById('addQuiltBtn');
    const form = document.getElementById('invoiceForm');
    const statusBox = document.getElementById('statusBox');

    function money(value) {
      const numericValue = Number(value) || 0;
      return numericValue.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    }

    function num(value) {
      const parsed = parseFloat(value);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function setTodayDefaults() {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('dateOrdered').value = today;
      if (!document.getElementById('signatureDate').value) {
        document.getElementById('signatureDate').value = today;
      }
    }

    function syncCustomerNameToSignature() {
      const customerNameInput = document.getElementById('customerName');
      const signatureNameInput = document.getElementById('signatureName');
      if (!customerNameInput || !signatureNameInput) return;
      signatureNameInput.value = customerNameInput.value;
    }

    function selectedNumber(selectEl, attr) {
      const option = selectEl.options[selectEl.selectedIndex];
      const value = parseFloat(option.getAttribute(attr));
      return Number.isFinite(value) ? value : 0;
    }

    function addQuilt() {
      const fragment = quiltTemplate.content.cloneNode(true);
      const card = fragment.querySelector('.quilt-card');

      card.querySelectorAll('input, select').forEach((el) => {
        el.addEventListener('input', recalcAll);
        el.addEventListener('change', recalcAll);
      });

      const threadTypeSelect = card.querySelector('.thread-type');
      const threadUpchargeInput = card.querySelector('.thread-upcharge');
      threadTypeSelect.addEventListener('change', () => {
        if (threadTypeSelect.value === 'Specialty' && (!threadUpchargeInput.value || Number(threadUpchargeInput.value) === 0)) {
          threadUpchargeInput.value = '10';
        }
        if (threadTypeSelect.value === 'Regular') {
          threadUpchargeInput.value = '0';
        }
        recalcAll();
      });

      card.querySelector('.remove-quilt-btn').addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        card.remove();
        renumberQuilts();
        recalcAll();
      });

      quiltContainer.appendChild(fragment);
      renumberQuilts();
      recalcAll();
    }

    function renumberQuilts() {
      const cards = quiltContainer.querySelectorAll('.quilt-card');
      cards.forEach((card, index) => {
        card.querySelector('.quilt-number').textContent = index + 1;
        const removeBtn = card.querySelector('.remove-quilt-btn');
        removeBtn.style.display = cards.length === 1 ? 'none' : 'inline-flex';
      });
    }

    function calculateCard(card) {
      const width = num(card.querySelector('.width').value);
      const length = num(card.querySelector('.length').value);
      const squareInches = width * length;

      const e2eRate = selectedNumber(card.querySelector('.e2e-design'), 'data-rate');
      const battingRate = selectedNumber(card.querySelector('.batting-type'), 'data-rate');
      const backingRate = selectedNumber(card.querySelector('.backing-supplied'), 'data-rate');
      const backingYards = num(card.querySelector('.backing-yards').value);

      const repairCharge = card.querySelector('.charge-repair').checked ? 10 : 0;
      const ironingCharge = card.querySelector('.charge-ironing').checked ? 10 : 0;
      const trimmingCharge = card.querySelector('.charge-trimming').checked ? 10 : 0;
      const threadUpcharge = num(card.querySelector('.thread-upcharge').value);

      const quiltingTotal = squareInches * e2eRate;
      const battingTotal = battingRate * backingYards;
      const backingTotal = backingRate * backingYards;
      const materialsTotal = battingTotal + backingTotal + threadUpcharge;
      const quiltExtrasTotal = repairCharge + ironingCharge + trimmingCharge;
      const subtotal = quiltingTotal + materialsTotal + quiltExtrasTotal;

      card.querySelector('.square-inches').value = squareInches ? squareInches.toFixed(2) : '';
      card.querySelector('.quilting-total').textContent = money(quiltingTotal);
      card.querySelector('.material-total').textContent = money(materialsTotal);
      card.querySelector('.quilt-extras-total').textContent = money(quiltExtrasTotal);
      card.querySelector('.quilt-line-subtotal').textContent = money(subtotal);

      card.querySelector('.quilt-square-inches-badge').textContent = squareInches ? `${squareInches.toFixed(2)} sq in` : '0.00 sq in';
      card.querySelector('.quilting-total-badge').textContent = money(quiltingTotal);
      card.querySelector('.materials-total-badge').textContent = money(materialsTotal);
      card.querySelector('.extras-total-badge').textContent = money(quiltExtrasTotal);

      return {
        subtotal,
        squareInches,
        quiltingTotal,
        battingTotal,
        backingTotal,
        quiltExtrasTotal,
        repairCharge,
        ironingCharge,
        trimmingCharge
      };
    }

    function recalcAll() {
      let combinedQuiltSubtotal = 0;
      const quiltCards = quiltContainer.querySelectorAll('.quilt-card');
      quiltCards.forEach((card) => {
        combinedQuiltSubtotal += calculateCard(card).subtotal;
      });

      const grandTotal = combinedQuiltSubtotal;

      document.getElementById('quiltCount').textContent = String(quiltCards.length);
      document.getElementById('combinedQuiltSubtotal').textContent = money(combinedQuiltSubtotal);
      document.getElementById('grandTotal').textContent = money(grandTotal);
    }

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatMultilineText(text) {
      return escapeHtml(text).replace(/\r\n|\r|\n/g, '<br>');
    }

    function currentDateLabel() {
      return new Date().toLocaleDateString(undefined, {
        year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    function buildPrintableInvoiceHtml() {
      const customer = {
        dateOrdered: document.getElementById('dateOrdered').value,
        requestedDate: document.getElementById('requestedDate').value,
        customerName: document.getElementById('customerName').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        customerNotes: document.getElementById('customerNotes').value,
        minimumAgreed: document.getElementById('minimumAgreed').value
      };

      const signatureName = document.getElementById('signatureName').value;
      const signatureDate = document.getElementById('signatureDate').value;
      const disclaimerText = document.getElementById('disclaimerText').innerText;

      let combinedQuiltSubtotal = 0;
      let quiltRows = '';
      let quiltDetails = '';

      quiltContainer.querySelectorAll('.quilt-card').forEach((card, index) => {
        const calc = calculateCard(card);
        combinedQuiltSubtotal += calc.subtotal;

        const width = num(card.querySelector('.width').value);
        const length = num(card.querySelector('.length').value);
        const pattern = card.querySelector('.pattern').value;
        const e2e = card.querySelector('.e2e-design').value;
        const custom = card.querySelector('.custom-design').value;
        const battingType = card.querySelector('.batting-type').value;
        const thread = card.querySelector('.thread-type').value;
        const backing = card.querySelector('.backing-supplied').value;
        const backingYards = card.querySelector('.backing-yards').value;
        const labelNotes = card.querySelector('.label-notes').value;
        const minutes = card.querySelector('.minutes-stitching').value;
        const minimumBorder = card.querySelector('.minimum-border').value;
        const lineMinimumAgreed = card.querySelector('.minimum-agreed-line').value;

        quiltRows += `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(pattern || `Quilt ${index + 1}`)}</td>
            <td>${escapeHtml(e2e)}</td>
            <td>${calc.squareInches.toFixed(2)}</td>
            <td>${escapeHtml(custom)}</td>
            <td>${money(calc.subtotal)}</td>
          </tr>`;

        quiltDetails += `
          <section class="quilt-detail">
            <h3>Quilt ${index + 1}: ${escapeHtml(pattern || `Quilt ${index + 1}`)}</h3>
            <table>
              <tr><th>Width x Length</th><td>${width} × ${length} in</td><th>Square Inches</th><td>${calc.squareInches.toFixed(2)}</td></tr>
              <tr><th>Pattern</th><td>${escapeHtml(pattern || '-')}</td><th>Quilting Design--Edge to Edge</th><td>${escapeHtml(e2e)}</td></tr>
              <tr><th>Quilting Design--Custom</th><td>${escapeHtml(custom)}</td><th>Minutes for Stitching</th><td>${escapeHtml(minutes)}</td></tr>
              <tr><th>Batting Type</th><td>${escapeHtml(battingType)}</td><th>Batting Total</th><td>${money(calc.battingTotal)}</td></tr>
              <tr><th>Thread</th><td>${escapeHtml(thread)}</td><th>Thread upcharge</th><td>${money(num(card.querySelector('.thread-upcharge').value))}</td></tr>
              <tr><th>B&N Supplied Backing Fabric</th><td>${escapeHtml(backing)}</td><th>Yards of Backing</th><td>${escapeHtml(backingYards)}</td></tr>
              <tr><th>Backing Total</th><td>${money(calc.backingTotal)}</td><th>Materials Total</th><td>${money(calc.battingTotal + calc.backingTotal + num(card.querySelector('.thread-upcharge').value))}</td></tr>
              <tr><th>Embroidered Quilt Label</th><td>${escapeHtml(labelNotes || '-')}</td><th>Minimum Outside Border</th><td>${escapeHtml(minimumBorder || '0')} in</td></tr>
              <tr><th>Minimum agreed</th><td>${escapeHtml(lineMinimumAgreed || '-')}</td><th>Repairs / Ironing / Trimming</th><td>${money(calc.repairCharge)} / ${money(calc.ironingCharge)} / ${money(calc.trimmingCharge)}</td></tr>
              <tr><th>Quilting Total</th><td>${money(calc.quiltingTotal)}</td><th>Extras Total</th><td>${money(calc.quiltExtrasTotal)}</td></tr>
              <tr><th>Line Item Subtotal</th><td><strong>${money(calc.subtotal)}</strong></td><th></th><td></td></tr>
            </table>
          </section>`;
      });

      const grandTotal = combinedQuiltSubtotal;

      return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Printable Quilting Invoice</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; color: #111827; margin: 28px; }
    .header { display: flex; justify-content: space-between; gap: 24px; border-bottom: 2px solid #111827; padding-bottom: 14px; margin-bottom: 20px; }
    h1 { margin: 0 0 6px; font-size: 28px; }
    h2 { margin: 22px 0 10px; font-size: 18px; }
    h3 { margin: 18px 0 10px; font-size: 15px; }
    p { margin: 4px 0; line-height: 1.5; }
    .meta, .customer { width: 100%; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 18px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #d1d5db; padding: 8px 10px; text-align: left; vertical-align: top; }
    th { background: #f3f4f6; width: 22%; }
    .summary-table td.amount { text-align: right; white-space: nowrap; }
    .invoice-table td, .invoice-table th { font-size: 14px; }
    .total-row td { font-weight: 700; font-size: 16px; background: #eef2ff; }
    .quilt-detail { page-break-inside: avoid; margin-top: 14px; }
    .disclaimer { border: 1px solid #d1d5db; background: #fafafa; padding: 12px; margin-top: 18px; }
    .signature { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .line { border-bottom: 1px solid #111827; min-height: 24px; padding-top: 4px; }
    @media print { body { margin: 16px; } }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>Long Arm Quilting Invoice</h1>
      <p>Prepared on ${escapeHtml(currentDateLabel())}</p>
    </div>
    <div class="meta">
      <p><strong>Date Ordered:</strong> ${escapeHtml(customer.dateOrdered)}</p>
      <p><strong>Requested Completion Date:</strong> ${escapeHtml(customer.requestedDate)}</p>
    </div>
  </div>

  <div class="two-col">
    <div class="customer">
      <h2>Customer Information</h2>
      <p><strong>Name:</strong> ${escapeHtml(customer.customerName)}</p>
      <p><strong>Phone:</strong> ${escapeHtml(customer.phone)}</p>
      <p><strong>Email:</strong> ${escapeHtml(customer.email)}</p>
      <p><strong>Minimum Agreed:</strong> ${escapeHtml(customer.minimumAgreed || '-')}</p>
      <p><strong>Notes:</strong> ${escapeHtml(customer.customerNotes || '-')}</p>
    </div>
    <div>
      <h2>Invoice Overview</h2>
      <table class="invoice-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Pattern</th>
            <th>E2E</th>
            <th>Sq In</th>
            <th>Custom</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          ${quiltRows}
        </tbody>
      </table>
    </div>
  </div>

  <h2>Detailed Quilt Line Items</h2>
  ${quiltDetails}

  <h2>Invoice Totals</h2>
  <table class="summary-table">
    <tr><th>Number of Quilts</th><td class="amount">${quiltContainer.querySelectorAll('.quilt-card').length}</td></tr>
    <tr><th>Combined Quilt Subtotal</th><td class="amount">${money(combinedQuiltSubtotal)}</td></tr>
    <tr class="total-row"><td>Total Due</td><td class="amount">${money(grandTotal)}</td></tr>
  </table>

  <div class="disclaimer">
    <strong>Disclaimer / Terms</strong>
    <p>${formatMultilineText(disclaimerText)}</p>
  </div>

  <div class="signature">
    <div>
      <strong>Customer Signature Name</strong>
      <div class="line">${escapeHtml(signatureName || '')}</div>
    </div>
    <div>
      <strong>Signature Date</strong>
      <div class="line">${escapeHtml(signatureDate || '')}</div>
    </div>
  </div>
</body>
</html>`;
    }

    function downloadFile(filename, content, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function runSelfTests() {
      const tests = [];
      tests.push({ name: 'escapeHtml escapes angle brackets', pass: escapeHtml('<b>Test</b>') === '&lt;b&gt;Test&lt;/b&gt;' });
      tests.push({ name: 'formatMultilineText converts newlines to br', pass: formatMultilineText('Line 1\nLine 2') === 'Line 1<br>Line 2' });
      tests.push({ name: 'money formats zero as USD', pass: typeof money(0) === 'string' && money(0).includes('0') });
      tests.push({ name: 'customer name input exists', pass: !!document.getElementById('customerName') });
      tests.push({ name: 'pattern field exists', pass: !!document.querySelector('.pattern') });
      tests.push({ name: 'e2e selector exists', pass: !!document.querySelector('.e2e-design') });
      tests.push({ name: 'repair checkbox exists', pass: !!document.querySelector('.charge-repair') });
      tests.push({ name: 'fixed disclaimer exists', pass: !!document.querySelector('.disclaimer-fixed') });
      tests.push({ name: 'quilt count summary exists', pass: !!document.getElementById('quiltCount') });
      tests.push({ name: 'quilt card is collapsible', pass: !!document.querySelector('details.quilt-card') });
      tests.push({ name: 'combined material summary exists', pass: !!document.querySelector('.material-total') });
      tests.push({ name: 'thread upcharge field exists', pass: !!document.querySelector('.thread-upcharge') });
      tests.push({ name: 'thread selector exists', pass: !!document.querySelector('.thread-type') });
      tests.push({ name: 'thread upcharge dollar label exists', pass: document.documentElement.innerHTML.includes('Thread upcharge ($)') });
      const failed = tests.filter((test) => !test.pass);
      if (failed.length) {
        console.error('Self-tests failed:', failed);
      } else {
        console.info('All self-tests passed.');
      }
    }

    addQuiltBtn.addEventListener('click', () => addQuilt());

    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (!form.reportValidity()) return;
      recalcAll();
      const html = buildPrintableInvoiceHtml();
      const safeName = (document.getElementById('customerName').value || 'invoice').trim().replace(/[^a-z0-9]+/gi, '_');
      const filename = `quilting_invoice_${safeName}.html`;
      downloadFile(filename, html, 'text/html;charset=utf-8');
      statusBox.style.display = 'block';
      statusBox.textContent = 'Printable invoice downloaded. Open the file in your browser and use Print or Save as PDF.';
    });

    document.getElementById('printBtn').addEventListener('click', () => {
      window.print();
    });

    form.addEventListener('reset', () => {
      setTimeout(() => {
        quiltContainer.innerHTML = '';
        addQuilt();
        setTodayDefaults();
        document.getElementById('disclaimerText').value = 'Final pricing and completion timing may be confirmed after review of the quilt top, materials, and requested quilting details.';
        statusBox.style.display = 'none';
        recalcAll();
      }, 0);
    });

    setTodayDefaults();
    document.getElementById('customerName').addEventListener('input', syncCustomerNameToSignature);
    addQuilt();
    recalcAll();
    runSelfTests();
  </script>
</body>
</html>
